/*! fs-rsync@1.2.0 2015-11-24 */
!function(a){"undefined"!=typeof module?module.exports=a(require("fs-rpc")):"function"==typeof define&&"object"==typeof define.amd?define(["fs-rpc"],a):"object"==typeof window&&(window.FSRSYNC=a(window.FSRPC()))}(function(a){"use strict";var b=function(){};return b.getFSRPC=function(){return a},b.remoteList=function(b,c,d){var e=a.Client(),f=c.path;b.send(e.add("readdirStat",f).stringify(),"rpc",function(a,b){var c;return a?d(a):(c=e.parse(b),void d.apply(null,c?c[0]:void 0))})},b.remoteStat=function(b,c,d){var e=a.Client(),f=c.filename;b.send(e.add("stat",f).stringify(),"rpc",function(a,b){var c;return a?d(a):(c=e.parse(b),void d.apply(null,c?c[0]:void 0))})},b.remoteReadFile=function(b,c,d){var e=a.Client(),f=c.filename;b.send(e.add("readFileChunked",[f]).stringify(),"rpc",function(a,b){var c,f;if(a)return d(a);try{if(c=e.parse(b)){if(f=c[0],f&&f[0]instanceof Error)return d(c[0]);if(f&&f[1]&&"string"==typeof f[1].content)return d.apply(null,[null,atob(f[1].content)]);d(null)}}catch(g){d(g)}})},b.localList=function(a,b){var c={};return a.readdirSync(b).forEach(function(d){c[d]=a.statSync(b+"/"+d)}),c},b.eachAsync=function(a,b,c){function d(a){setTimeout(function(){c(a||null)},0)}var e,f=0;return a&&0!==a.length?(e=new Promise(function(c,d){function e(c,d){try{b.call(null,a[f],function(a){a instanceof Error?d(a):c()})}catch(e){d(e)}}function g(){++f,f<a.length?(i=new Promise(e),i.then(g,h)):c()}function h(a){d(a)}var i;i=new Promise(e),i.then(g,h)}),void e.then(d,d)):void c()},b.syncDir=function(a,c,d){function e(c,e){var h=b.localList(f,g);return c?d(c):void b.eachAsync(Object.keys(e),function(c,d){var i=e[c];h[c]?d():i.isDirectory?f.mkdir(g+c,d):b.remoteReadFile(a,{filename:g+c},function(a,b){return a?d(a):void f.writeFile(g+c,b,d)})},function(a){d(a,g)})}var f=c.fs,g=c.path;"/"!==g[g.length-1]&&(g+="/"),b.remoteList(a,{path:g},e)},b});